---
layout: post
title: "[개발일지] 텔레그램 모니터링 시스템 1"
tags: [개발일지, 텔레그램, Python]
comments: true
---

텔레그램 모니터링 시스템 개발과정

> 이렇게까지 커질줄 몰랐던, 새싹에서 시작해 나무로 자라난 프로젝트

---
## (1) 개요
보안관제 업무를 진행하다 보면, 사기업의 경우 단순 네트워크 트래픽 탐지 뿐만 아니라 보안 동향을 파악하는 과업을 같이 수행하기도 한다. 국내외 최신 동향을 파악하여 보고서를 작성하는 일 뿐만 아니라, 크리덴션 스터핑 방지를 위해 오픈된 db 등의 데이터로부터 아이디 또는 이메일 등의 문자열이 확인되는지를 파악한다.

우리 팀은 PM님의 아이디어 하에 고객사의 크리덴셜 스터핑 방지를 위해 텔레그램 모니터링을 진행하고자 했다.

PM님이 기존에 관리하고 있던 텔레그램 채널 몇개와, 우리 팀이 추가적으로 찾은 채널에 대한 집중 모니터링을 진행하기 시작했다.

### 1. 구상
처음에는 지정한 몇개의 채널에 접속하여, 수동으로 파일을 다운받아 문자열 ex) @eric을 검색하였다. 채널의 수가 적으면 수동으로 충분히 감당할 수 있지만, 채널이 많아지면 시간과 인력 소모가 굉장히 많아질 것이라 판단하여, python으로 다운로드와 검색이 가능한 스크립트를 찾아보기로 했다.

### 2. 문제점
그러나, 인터넷에 오픈되어 있는 소스들은 대부분 너무 복잡했으며, 스크립트에 내가 원하는 기능을 마음대로 추가하기 복잡했으므로 그대로 활용하기 어려웠다.

또한 해당 소스코드에 보안상의 허점과 문제를 식별하기도 어렵기에 그대로 실행하기엔 어렵다는 결론에 다달았다.

결국 학교에서 배우고 현장실습 때 가다듬은 자동화에 최적화된 언어 python으로 개발하기로 했다.

## (2) 설계
소스코드를 짜기 전에, 프로그램을 어떤식으로 구동할 것인지 생각해보았다.

우리는 먼저 1. 데이터를 채널로부터 추출해야하고, 2. 압축을 해제하고, 3. 그 다음 특정 문자열을 검색하고, 4. 검색 결과를 출력해야한다.

이렇게 3단계를 거치면 좋겠다고 생각했다. 또, 이를 하나의 스크립트에 우겨넣으면 에러가 무지막지하게 발생하겠다 싶어서, 3개의 별도의 스크립트와, 이를 실행시킬 하나의 스크립트를 작성하기로 생각했다.

## (3) 제작
### 1. 텔레그램 클라이언트 접근 및 다운로드 코드
아래는 텔레그램 클라이언트 접근 및 채널에서 파일 검색을 검색하고 다운로드를 진행하는 코드이다.

#### 1-1. 클라이언트 접근
![스크린샷 2024-04-25 오후 2 23 19](https://github.com/what0302/what0302.github.io/assets/18510716/9514cfda-d26a-46d5-b5c4-29a7ec77da89)

우선, 'telethon' 라이브러리를 이용해야한다. 

telethon은 파이썬 텔레그램 클라이언트 모듈이다. 이를 이용해 텔레그램을 별도로 실행하지 않아도 텔레그램 클라이언트에 접근이 가능하며, 파일 다운로드가 가능하다.

#### 1-2. 채널 매핑
![image](https://github.com/what0302/what0302.github.io/assets/18510716/2bcb88a3-a95a-4d30-ba79-4583b4ceac28)

선별한 채널과 채널 아이디를 매핑하는 단계이다. 채널 아이디에 채널명을 연결지어, 채널에 대응하는 폴더 이름을 매핑한 딕셔너리로 모니터링 대상이 되는 채널들을 리스트에 추가한다.

#### 1-3. 검색 기간 설정
![image](https://github.com/what0302/what0302.github.io/assets/18510716/48f659bd-476b-4894-9b72-c8e2f322651b)

서울 시간대를 기준으로 다운로드할 파일의 검색 기간을 설정한다. 하루에 한번 1일치의 파일을 검색하고자 하면 1로 설정하면 된다.

#### 1-4. 다운로드 경로 설정
![image](https://github.com/what0302/what0302.github.io/assets/18510716/a5a281bb-6948-48f2-9ed7-6fc4d1930df1)

다운로드한 파일을 저장한 폴더의 경로를 설정해준다.

#### 1-5. 세션 생성
![image](https://github.com/what0302/what0302.github.io/assets/18510716/92a8ee84-644c-4718-888f-36bd939c7a52)

파이썬으로 다운로드 및 결과 출력을 자동화시키기 위해서는 세션이 꼭 필요하다. 매번 프로그램을 실행시키고 인증을 해준다면 그건 수동과 다를 바가 없기 때문이다.

또, 추후 윈도우 스케줄러를 통해 매크로를 돌릴거면 세션은 꼭 만들어줘야 한다.

#### 1-6. 다운로드 진행 상황 확인
![image](https://github.com/what0302/what0302.github.io/assets/18510716/7ad12a05-d8b5-4f17-bd06-7eaf486b4847)

다운로드 진행 상황을 확인하기 위한 코드이다. 에러가 발생하거나 네트워크 연결 오류 및 채널 문제로 다운로드가 진행이 되지 않을 경우 시각적으로 파악할 수 있기에 추가해준다.

#### 1-7. 채널별 폴더 생성
![image](https://github.com/what0302/what0302.github.io/assets/18510716/88664721-2020-473c-9ec0-0c978af28b8b)

이전에 채널과 채널 아이디를 매핑한 것을 가져와서, 해당 채널 이름으로 폴더를 생성한다. 찾고자 하는 문자열을 검색하더라도, 어느 채널에서 다운로드한 파일인지 확인하기 위함이다. 

이는 보고할 때 특히 필수이다.

#### 1-8. 날짜별 폴더 생성
![image](https://github.com/what0302/what0302.github.io/assets/18510716/77b86cac-07b2-4914-b8ea-f3f6bd16e98f)

채널별 폴더의 디렉토리에 날짜별로 폴더를 생성하여 데이터를 관리한다. 데이터를 날짜별로 관리함으로써, 추후 지난 데이터를 삭제할 때 용이하기 위함이 있고, 데이터를 가시적으로 관리하기 쉽게 하기 위함이다.


### 2. 압축 해제 코드
다운로드 디렉토리 내에 압축파일이 존재할 경우 해제하는 코드이다.

#### 2-1. 압축 해제
![image](https://github.com/what0302/what0302.github.io/assets/18510716/2ed8808d-f3bf-4e2c-b851-e99a6f3389e5)

압축을 해제하기 위해 파이썬의 라이브러리를 이용한다. 여기서는 'zipfile'과 'pyzipper'을 사용한다. 

zipfile은 CRC32 암호화된 zip 파일만 지원하고, pyzipper은 AES-128로 암호화된 zip 파일을 지원하므로, 두 모듈을 모두 사용한다.

쉽게 말해, .zip을 열기 위해선 zipfile, .7z을 열기 위해선 pyzipper을 사용하면 된다.

### 3. 문자열 검색 코드
지정된 디렉토리 내에 특정 문자열이 존재하는지 검색하는 코드이다. 검색 결과를 .txt 형태로 추출하며 엑셀 형태로도 가공이 가능하다.

#### 3-1. 문자열 검색
![image](https://github.com/what0302/what0302.github.io/assets/18510716/c33c89a1-be09-4395-9530-e462a5686ea9)

### 4. 데이터 삭제 코드
지정된 날짜를 지난 데이터를 삭제하는 코드이다.

#### 4-1. 데이터 삭제
![image](https://github.com/what0302/what0302.github.io/assets/18510716/21c72c52-3391-410b-920f-75c433230d18)

다운받은 데이터를 무기한 저장할 수는 없다. 데이터 관리의 효율성을 위해 30일 지난 과거의 데이터를 삭제하도록 한다.

이전에 채널별로 날짜별로 데이터를 저장한 것이 이 이유이다. 혹은, 파일의 메타데이터를 읽고 분류하는 것도 가능할 수 있다.

파이썬에서는 importlib.metadata 혹은 os.path 모듈의 stat() 함수를 사용해 메타데이터를 읽을 수 있다.

### 5. 프로그램 실행 코드
앞에서 작성한 4개의 스크립트를 한번에 작동시키는 코드이다.

#### 5-1. 프로세스 일괄 동작
![image](https://github.com/what0302/what0302.github.io/assets/18510716/ebaacef3-0010-4135-ae26-9769c53a84cc)

























